# FlowLens Schema Documentation (field-level)

This document lists every field in the existing tables and a short description.

### Table: `raw_events`

- `id` (UUID PK): unique id for the raw event
- `event_type` (TEXT): GitHub event type (e.g., `pull_request`, `workflow_run`, `push`)
- `delivery_id` (TEXT, UNIQUE): GitHub delivery id; used to dedupe repeated deliveries
- `payload` (JSONB): full raw webhook payload
- `processed` (BOOLEAN): flag whether event was consumed by processing logic
- `received_at` (TIMESTAMPTZ): when the service received the event

### Table: `insights`

- `id` (UUID PK): insight record id
- `pr_number` (INT): PR number this insight is about
- `commit_sha` (TEXT): commit SHA associated with the insight (if any)
- `author` (TEXT): author of the insight or the commit
- `avatar_url` (TEXT): avatar for display
- `risk_level` (TEXT - enum): one of `low|medium|high`
- `summary` (TEXT): one-line summary generated by AI
- `recommendation` (TEXT): action suggestion generated by AI
- `created_at` (TIMESTAMPTZ): timestamp when insight was created

### Table: `pipeline_runs`

- `id` (UUID PK): pipeline run id
- `pr_number` (INT, UNIQUE): PR number associated with this pipeline
- `commit_sha` (TEXT): last known commit SHA
- `author` (TEXT): author of the pipeline change
- `avatar_url` (TEXT): author avatar url
- `title` (TEXT): PR title
- `status_pr` (TEXT): PR creation status (e.g., `opened`, `updated`)
- `status_build` (TEXT): build status (`running`, `passed`, `failed`)
- `status_approval` (TEXT): approval status (`approved`, `changes_requested`)
- `status_merge` (TEXT): merge status (`merged`, `closed`, etc.)
- `history` (JSONB): array of timestamped status changes appended by the ingestion service; each entry looks like { field, value, at }
- `created_at` (TIMESTAMPTZ)
- `updated_at` (TIMESTAMPTZ)

### Table: `pull_requests`

- `pr_number` (INT PK): PR number
- `title` (TEXT): PR title
- `author` (TEXT): PR author login
- `author_avatar` (TEXT): avatar URL for author
- `commit_sha` (TEXT): latest head SHA for the PR
- `repository_name` (TEXT): repository full name
- `branch_name` (TEXT): source branch name for the PR
- `base_branch` (TEXT): target branch (master/main/etc.)
- `pr_url` (TEXT): HTML URL for the PR
- `commit_urls` (JSONB): array of commit URLs (strings)
- `additions` (INT): total lines added
- `deletions` (INT): total lines deleted
- `changed_files` (INT): number of changed files
- `commits_count` (INT): number of commits in the PR
- `labels` (JSONB): array of labels (objects with name, color)
- `assignees` (JSONB): array of assignee objects
- `reviewers` (JSONB): array of requested reviewer objects
- `is_draft` (BOOLEAN): whether PR is draft
- `state` (TEXT): `open|closed|merged`
- `history` (JSONB): array of timestamped PR-level entries appended by ingestion; entries are small objects such as { at, title, state, commit_sha }
- `created_at` (TIMESTAMPTZ)
- `updated_at` (TIMESTAMPTZ)

### Notes & behavior

- The ingestion service uses UPSERT (INSERT ... ON CONFLICT) for both `pull_requests` and `pipeline_runs` so multiple webhook events for the same PR update the same row rather than creating duplicates.
- The `history` JSONB fields are a lightweight audit trail. They're good for hackathon/low-volume usage. For high-throughput or strict audit requirements, migrate to an append-only `pipeline_run_history` table later.
