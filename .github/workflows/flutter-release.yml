name: Flutter Release APK

on:
  push:
    branches: [main]

env:
  FLUTTER_VERSION: "3.35.2"
  JAVA_VERSION: "17"

jobs:
  # Job to build and release APK when PR is merged to main
  build-and-release:
    name: Build and Release APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: Disable Flutter analytics
        run: flutter config --no-analytics

      - name: Get Flutter dependencies
        working-directory: ./flutter_app
        run: flutter pub get

      - name: Run Flutter analyze
        working-directory: ./flutter_app
        run: flutter analyze

      - name: Generate version info
        id: version_info
        run: |
          # Extract version from pubspec.yaml
          VERSION=$(grep '^version:' flutter_app/pubspec.yaml | cut -d ' ' -f 2 | tr -d '\r' | tr -d '\n')
          BUILD_NUMBER=$(date +%s)

          # Clean version string
          VERSION_CLEAN=$(echo $VERSION | sed 's/+.*//')

          echo "version=$VERSION_CLEAN" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "release_name=FlowLens-v$VERSION_CLEAN" >> $GITHUB_OUTPUT

      - name: Build APK
        working-directory: ./flutter_app
        run: |
          flutter build apk --release \
            --build-name=${{ steps.version_info.outputs.version }} \
            --build-number=${{ steps.version_info.outputs.build_number }}

      - name: Rename APK file
        run: |
          cd flutter_app/build/app/outputs/flutter-apk
          mv app-release.apk flowlens-${{ steps.version_info.outputs.version }}-release.apk

      - name: Generate changelog
        id: changelog
        run: |
          # Create simple changelog file
          cat > CHANGELOG.md << 'EOF'
          ## FlowLens v${{ steps.version_info.outputs.version }}

          ### Technical Details:
          - App Version: ${{ steps.version_info.outputs.version }}
          - Build Number: ${{ steps.version_info.outputs.build_number }}
          - Flutter Version: ${{ env.FLUTTER_VERSION }}

          ### Download:
          - APK: Direct installation file for Android devices

          ### Installation:
          1. Download the APK file
          2. Enable 'Unknown sources' in your Android device settings
          3. Install the APK file
          4. Enjoy FlowLens!
          EOF

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version_info.outputs.version }}-${{ steps.version_info.outputs.build_number }}
          name: ${{ steps.version_info.outputs.release_name }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            ./flutter_app/build/app/outputs/flutter-apk/flowlens-${{ steps.version_info.outputs.version }}-release.apk

      - name: Notify build completion
        run: |
          echo "âœ… FlowLens Release Build Completed Successfully!"
          echo "ðŸ“± APK: flowlens-${{ steps.version_info.outputs.version }}-release.apk"
          echo "ðŸ·ï¸ Release created with tag: v${{ steps.version_info.outputs.version }}-${{ steps.version_info.outputs.build_number }}"
